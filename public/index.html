<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Viewer + Mongo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <header class="border-b border-slate-700 bg-slate-900/60">
      <div class="max-w-7xl mx-auto p-4">
        <h1 class="text-cyan-300 text-xl font-semibold">Sketchfab + Mongo Demo</h1>
      </div>
    </header>

    <main class="max-w-7xl mx-auto p-4">
      <section class="flex flex-col gap-3 md:flex-row md:items-center">
        <input id="uid" placeholder="輸入 Sketchfab 模型 UID" size="40" class="flex-1 min-w-[260px] rounded-md border border-slate-700 bg-slate-900/60 px-3 py-2 text-slate-100 placeholder-slate-500" />
        <div class="flex gap-2">
          <button id="import" class="px-3 py-2 rounded-md border border-slate-700 hover:border-cyan-300 hover:text-cyan-300">匯入</button>
          <button id="latest" class="px-3 py-2 rounded-md border border-slate-700 hover:border-cyan-300 hover:text-cyan-300">載入最新</button>
        </div>
        <span id="status" class="text-slate-400 text-sm"></span>
      </section>

      <!-- 模型列表（最上方） -->
      <section class="mt-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-slate-300 text-base">模型列表</h2>
          <span class="text-slate-400 text-sm">共 <b id="count">0</b> 筆</span>
        </div>
        <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3"></div>
      </section>

      <!-- Viewer（列表下方） -->
      <section class="mt-6 rounded-xl border border-slate-700 bg-slate-900/40 p-3">
        <div class="w-full max-w-5xl mx-auto">
          <div class="w-full aspect-[4/3] rounded-lg overflow-hidden border border-slate-700">
            <iframe
              id="viewer"
              class="w-full h-full"
              allow="autoplay; fullscreen; accelerometer; gyroscope; magnetometer; xr-spatial-tracking"
            ></iframe>
          </div>
        </div>
      </section>

      <!-- 欄位概覽與原始文件（Viewer 下方） -->
      <section class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="rounded-xl border border-slate-700 bg-slate-900/40 p-3">
          <h2 class="text-slate-300 text-base mb-2">欄位概覽（當前模型）</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-slate-400">
                  <th class="text-left font-medium py-2 pr-4">Field</th>
                  <th class="text-left font-medium py-2 pr-4">Type</th>
                  <th class="text-left font-medium py-2">Example</th>
                </tr>
              </thead>
              <tbody id="schema"></tbody>
            </table>
          </div>
        </div>
        <div class="rounded-xl border border-slate-700 bg-slate-900/40 p-3">
          <h2 class="text-slate-300 text-base mb-2">Mongo 原始文件（當前模型）</h2>
          <pre id="doc" class="text-xs text-slate-300 bg-slate-950/60 rounded-lg border border-slate-700 p-3 overflow-auto max-h-[50vh] whitespace-pre-wrap break-words"></pre>
        </div>
      </section>
    </main>

<script>
      function setStatus(s){ document.getElementById('status').textContent = s; }

      async function importModel(){
        const uid = document.getElementById('uid').value.trim();
        if (!uid) return;
        const r = await fetch('/api/import/' + uid, { method: 'POST' });
        setStatus('import ' + uid + ' => ' + r.status);
        await list();
        await render(uid);
        try {
          const j = await (await fetch('/api/models/' + encodeURIComponent(uid))).json();
          if (j.ok) showDoc(j.model);
        } catch {}
      }

      function showDoc(doc){
        const pre = document.getElementById('doc');
        pre.textContent = JSON.stringify(doc, null, 2);
      }

      function getType(v){
        if (v === null) return 'null';
        if (Array.isArray(v)) return 'array';
        if (v && typeof v === 'object' && typeof v.$date !== 'undefined') return 'date';
        if (v instanceof Date) return 'date';
        return typeof v;
      }

      function stringifyExample(v){
        try{
          // handle ISODate from Mongo JSON if any
          if (v && typeof v === 'object' && typeof v.$date !== 'undefined') return new Date(v.$date).toISOString();
          const s = typeof v === 'object' ? JSON.stringify(v) : String(v);
          return s.length > 100 ? s.slice(0,100) + '…' : s;
        }catch{ return ''; }
      }

      async function list(){
        const d = await (await fetch('/api/models')).json();
        const grid = document.getElementById('grid');
        const count = document.getElementById('count');
        grid.innerHTML = '';
        count.textContent = Array.isArray(d.models) ? d.models.length : 0;
        for (const m of d.models) {
          const card = document.createElement('article');
          card.className = 'rounded-lg border border-slate-700 p-3 bg-slate-900/40 hover:border-cyan-300 transition-colors';
          const title = m.name || m.uid;
          const author = m.author || '';
          const updatedAt = m.updatedAt ? new Date(m.updatedAt).toLocaleString() : '';
          card.innerHTML = `
            <h3 class="text-slate-200 text-sm font-semibold truncate">${title}</h3>
            <p class="text-slate-400 text-xs truncate">UID: ${m.uid}</p>
            <p class="text-slate-500 text-xs truncate">Author: ${author}</p>
            <p class="text-slate-500 text-xs">Updated: ${updatedAt}</p>
          `;
          card.style.cursor = 'pointer';
          card.onclick = () => { render(m.uid); showDoc(m); buildSchema(m); };
          grid.appendChild(card);
        }
      }

      function buildSchema(doc){
        const schemaBody = document.getElementById('schema');
        schemaBody.innerHTML = '';
        const hidden = new Set(['__v']); // 不顯示與模型無關的版本欄位
        for (const [k, v] of Object.entries(doc)){
          if (hidden.has(k)) continue;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="py-2 pr-4 align-top text-slate-200">${k}</td>
            <td class="py-2 pr-4 align-top text-cyan-300">${getType(v)}</td>
            <td class="py-2 align-top text-slate-400 whitespace-pre-wrap break-words">${stringifyExample(v)}</td>
          `;
          schemaBody.appendChild(tr);
        }
      }

      async function render(uid){
        const iframe = document.getElementById('viewer');
        iframe.src = 'about:blank';
        const client = new Sketchfab(iframe);
        client.init(uid, { success(api){ api.start(); } });
      }

      document.getElementById('import').onclick = importModel;
      document.getElementById('latest').onclick = async () => {
        const d = await (await fetch('/api/model')).json();
        if (d.ok) {
          render(d.uid);
          try {
            const j = await (await fetch('/api/models/' + encodeURIComponent(d.uid))).json();
            if (j.ok) { showDoc(j.model); buildSchema(j.model); }
          } catch {}
        }
      };

list();
    </script>
  </body>
 </html>
